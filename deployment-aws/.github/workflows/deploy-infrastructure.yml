# Terraform ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# ðŸŽ¯ å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ:
# - GitHub Actions ã§ã® Terraform å®Ÿè¡Œ
# - AWS èªè¨¼æƒ…å ±ã®å®‰å…¨ãªç®¡ç†
# - ç’°å¢ƒåˆ¥ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒ‡ãƒ—ãƒ­ã‚¤

name: Deploy Infrastructure

# TODO: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  # terraform ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´æ™‚
  push:
    branches:
      - main
      - develop
    paths:
      - 'terraform/**'
      - '.github/workflows/deploy-infrastructure.yml'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      destroy:
        description: 'Destroy infrastructure'
        required: false
        default: false
        type: boolean

# TODO: ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
env:
  TF_VERSION: '1.6.0'
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}

# TODO: ã‚¸ãƒ§ãƒ–ã®å®šç¾©
jobs:
  # ç’°å¢ƒã®æ±ºå®š
  determine-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

  # Terraform ãƒ—ãƒ©ãƒ³ã®ä½œæˆ
  terraform-plan:
    runs-on: ubuntu-latest
    needs: determine-environment
    environment: ${{ needs.determine-environment.outputs.environment }}
    
    steps:
      # TODO: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # TODO: Terraform ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # TODO: AWS èªè¨¼æƒ…å ±ã®è¨­å®š
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # TODO: Terraform ã®åˆæœŸåŒ–
      - name: Terraform Init
        working-directory: terraform
        run: |
          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
          cat > backend.tf << EOF
          terraform {
            backend "s3" {
              bucket = "${{ secrets.TF_STATE_BUCKET }}"
              key    = "simple-crud-board/${{ needs.determine-environment.outputs.environment }}/terraform.tfstate"
              region = "${{ env.AWS_REGION }}"
              dynamodb_table = "${{ secrets.TF_LOCK_TABLE }}"
              encrypt = true
            }
          }
          EOF
          
          terraform init

      # TODO: Terraform ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆãƒã‚§ãƒƒã‚¯
      - name: Terraform Format Check
        working-directory: terraform
        run: terraform fmt -check -recursive

      # TODO: Terraform ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      - name: Terraform Validate
        working-directory: terraform
        run: terraform validate

      # TODO: Terraform ãƒ—ãƒ©ãƒ³
      - name: Terraform Plan
        working-directory: terraform
        run: |
          terraform plan \
            -var-file="environments/${{ needs.determine-environment.outputs.environment }}/terraform.tfvars" \
            -out=tfplan \
            -detailed-exitcode
        continue-on-error: true
        id: plan

      # TODO: ãƒ—ãƒ©ãƒ³çµæžœã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆPull Request ã®å ´åˆï¼‰
      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `
            #### Terraform Plan ðŸ“– \`${{ steps.plan.outcome }}\`
            
            <details><summary>Show Plan</summary>
            
            \`\`\`terraform
            ${{ steps.plan.outputs.stdout }}
            \`\`\`
            
            </details>
            
            *Environment: ${{ needs.determine-environment.outputs.environment }}*
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      # TODO: ãƒ—ãƒ©ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload plan file
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ needs.determine-environment.outputs.environment }}
          path: terraform/tfplan
          retention-days: 1

  # Terraform é©ç”¨
  terraform-apply:
    runs-on: ubuntu-latest
    needs: [determine-environment, terraform-plan]
    environment: ${{ needs.determine-environment.outputs.environment }}
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
    
    steps:
      # TODO: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # TODO: Terraform ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      # TODO: AWS èªè¨¼æƒ…å ±ã®è¨­å®š
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # TODO: ãƒ—ãƒ©ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: Download plan file
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ needs.determine-environment.outputs.environment }}
          path: terraform/

      # TODO: Terraform ã®åˆæœŸåŒ–
      - name: Terraform Init
        working-directory: terraform
        run: |
          cat > backend.tf << EOF
          terraform {
            backend "s3" {
              bucket = "${{ secrets.TF_STATE_BUCKET }}"
              key    = "simple-crud-board/${{ needs.determine-environment.outputs.environment }}/terraform.tfstate"
              region = "${{ env.AWS_REGION }}"
              dynamodb_table = "${{ secrets.TF_LOCK_TABLE }}"
              encrypt = true
            }
          }
          EOF
          
          terraform init

      # TODO: Terraform é©ç”¨ã¾ãŸã¯ç ´æ£„
      - name: Terraform Apply/Destroy
        working-directory: terraform
        run: |
          if [ "${{ github.event.inputs.destroy }}" = "true" ]; then
            echo "Destroying infrastructure..."
            terraform destroy \
              -var-file="environments/${{ needs.determine-environment.outputs.environment }}/terraform.tfvars" \
              -auto-approve
          else
            echo "Applying infrastructure changes..."
            terraform apply tfplan
          fi

      # TODO: Terraform å‡ºåŠ›å€¤ã®å–å¾—
      - name: Get Terraform Outputs
        if: github.event.inputs.destroy != 'true'
        working-directory: terraform
        id: outputs
        run: |
          echo "s3_bucket_name=$(terraform output -raw s3_bucket_name)" >> $GITHUB_OUTPUT
          echo "api_gateway_url=$(terraform output -raw api_gateway_url)" >> $GITHUB_OUTPUT
          echo "lambda_function_name=$(terraform output -raw lambda_function_name)" >> $GITHUB_OUTPUT
          echo "dynamodb_table_name=$(terraform output -raw dynamodb_table_name)" >> $GITHUB_OUTPUT

      # TODO: å‡ºåŠ›å€¤ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆä»–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ä½¿ç”¨ï¼‰
      - name: Save outputs
        if: github.event.inputs.destroy != 'true'
        run: |
          mkdir -p outputs
          cat > outputs/terraform-outputs.json << EOF
          {
            "s3_bucket_name": "${{ steps.outputs.outputs.s3_bucket_name }}",
            "api_gateway_url": "${{ steps.outputs.outputs.api_gateway_url }}",
            "lambda_function_name": "${{ steps.outputs.outputs.lambda_function_name }}",
            "dynamodb_table_name": "${{ steps.outputs.outputs.dynamodb_table_name }}",
            "environment": "${{ needs.determine-environment.outputs.environment }}"
          }
          EOF

      # TODO: å‡ºåŠ›å€¤ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload outputs
        if: github.event.inputs.destroy != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ needs.determine-environment.outputs.environment }}
          path: outputs/terraform-outputs.json
          retention-days: 7

      # TODO: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆçµæžœã®é€šçŸ¥
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Infrastructure Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ github.event.inputs.destroy == 'true' && 'Destroy' || 'Deploy' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.destroy }}" != "true" ]; then
            echo "**Resources Created:**" >> $GITHUB_STEP_SUMMARY
            echo "- S3 Bucket: ${{ steps.outputs.outputs.s3_bucket_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- Lambda Function: ${{ steps.outputs.outputs.lambda_function_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- DynamoDB Table: ${{ steps.outputs.outputs.dynamodb_table_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- API Gateway: ${{ steps.outputs.outputs.api_gateway_url }}" >> $GITHUB_STEP_SUMMARY
          fi