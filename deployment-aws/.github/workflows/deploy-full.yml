# å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# ðŸŽ¯ å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ:
# - è¤‡æ•°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®é€£æºå®Ÿè¡Œ
# - ä¾å­˜é–¢ä¿‚ã®ã‚ã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆé †åº
# - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥

name: Full Deployment

# TODO: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚
  push:
    branches:
      - main
      - develop
  
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      skip_infrastructure:
        description: 'Skip infrastructure deployment'
        required: false
        default: false
        type: boolean
      skip_tests:
        description: 'Skip tests'
        required: false
        default: false
        type: boolean

# TODO: ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
env:
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
  NODE_VERSION: '18'
  GO_VERSION: '1.21'

# TODO: ã‚¸ãƒ§ãƒ–ã®å®šç¾©
jobs:
  # ç’°å¢ƒã®æ±ºå®š
  setup:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      skip_infrastructure: ${{ steps.env.outputs.skip_infrastructure }}
      skip_tests: ${{ steps.env.outputs.skip_tests }}
    steps:
      - name: Determine deployment parameters
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "skip_infrastructure=${{ github.event.inputs.skip_infrastructure }}" >> $GITHUB_OUTPUT
            echo "skip_tests=${{ github.event.inputs.skip_tests }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "skip_infrastructure=false" >> $GITHUB_OUTPUT
            echo "skip_tests=false" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "skip_infrastructure=false" >> $GITHUB_OUTPUT
            echo "skip_tests=false" >> $GITHUB_OUTPUT
          fi

  # ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
  run-tests:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.skip_tests != 'true'
    
    steps:
      # TODO: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # TODO: Node.js ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # TODO: Go ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: lambda/go.sum

      # TODO: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
      - name: Run frontend tests
        working-directory: frontend
        run: |
          npm ci
          npm run test
          npm run lint
          npm run type-check

      # TODO: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
      - name: Run backend tests
        working-directory: lambda
        run: |
          go mod download
          go test -v ./...
          go vet ./...

  # ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-infrastructure:
    needs: [setup, run-tests]
    if: always() && (needs.run-tests.result == 'success' || needs.setup.outputs.skip_tests == 'true') && needs.setup.outputs.skip_infrastructure != 'true'
    uses: ./.github/workflows/deploy-infrastructure.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}
    secrets: inherit

  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-backend:
    needs: [setup, deploy-infrastructure]
    if: always() && (needs.deploy-infrastructure.result == 'success' || needs.setup.outputs.skip_infrastructure == 'true')
    uses: ./.github/workflows/deploy-backend.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}
    secrets: inherit

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-frontend:
    needs: [setup, deploy-infrastructure, deploy-backend]
    if: always() && needs.deploy-backend.result == 'success'
    uses: ./.github/workflows/deploy-frontend.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}
      api_gateway_url: ${{ needs.deploy-infrastructure.outputs.api_gateway_url }}
    secrets: inherit

  # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå¾Œã®ãƒ†ã‚¹ãƒˆ
  post-deployment-tests:
    runs-on: ubuntu-latest
    needs: [setup, deploy-frontend]
    if: always() && needs.deploy-frontend.result == 'success'
    environment: ${{ needs.setup.outputs.environment }}
    
    steps:
      # TODO: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # TODO: ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å‡ºåŠ›ã®å–å¾—
      - name: Download infrastructure outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs-${{ needs.setup.outputs.environment }}
          path: outputs/

      # TODO: API ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      - name: API Health Check
        run: |
          API_URL=$(cat outputs/terraform-outputs.json | jq -r '.api_gateway_url')
          echo "Testing API at: $API_URL"
          
          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ
          curl -f "$API_URL/health" || exit 1
          
          # æŠ•ç¨¿ä¸€è¦§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ
          curl -f "$API_URL/api/posts" || exit 1

      # TODO: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆ
      - name: Frontend Smoke Test
        run: |
          S3_BUCKET=$(cat outputs/terraform-outputs.json | jq -r '.s3_bucket_name')
          WEBSITE_URL="http://$S3_BUCKET.s3-website-${{ env.AWS_REGION }}.amazonaws.com"
          echo "Testing frontend at: $WEBSITE_URL"
          
          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®åŸºæœ¬çš„ãªå‹•ä½œç¢ºèª
          curl -f "$WEBSITE_URL" || exit 1

  # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆçµæžœã®é€šçŸ¥
  notify-deployment-result:
    runs-on: ubuntu-latest
    needs: [setup, run-tests, deploy-infrastructure, deploy-backend, deploy-frontend, post-deployment-tests]
    if: always()
    
    steps:
      # TODO: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆçµæžœã®åˆ¤å®š
      - name: Determine deployment result
        id: result
        run: |
          if [ "${{ needs.post-deployment-tests.result }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=âœ… Deployment completed successfully" >> $GITHUB_OUTPUT
          elif [ "${{ needs.deploy-frontend.result }}" = "failure" ] || [ "${{ needs.deploy-backend.result }}" = "failure" ] || [ "${{ needs.deploy-infrastructure.result }}" = "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=âŒ Deployment failed" >> $GITHUB_OUTPUT
          else
            echo "status=partial" >> $GITHUB_OUTPUT
            echo "message=âš ï¸ Deployment completed with warnings" >> $GITHUB_OUTPUT
          fi

      # TODO: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚µãƒžãƒªãƒ¼ã®ä½œæˆ
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Full Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.result.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.run-tests.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Infrastructure: ${{ needs.deploy-infrastructure.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ needs.deploy-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.deploy-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Post-deployment Tests: ${{ needs.post-deployment-tests.result }}" >> $GITHUB_STEP_SUMMARY

      # TODO: Slacké€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      # - name: Notify Slack
      #   if: always()
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ steps.result.outputs.status }}
      #     text: ${{ steps.result.outputs.message }}
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¤±æ•—æ™‚ï¼‰
  rollback:
    runs-on: ubuntu-latest
    needs: [setup, deploy-infrastructure, deploy-backend, deploy-frontend, post-deployment-tests]
    if: failure() && needs.setup.outputs.environment == 'prod'
    environment: ${{ needs.setup.outputs.environment }}
    
    steps:
      # TODO: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # TODO: å‰å›žã®æˆåŠŸã—ãŸãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
      - name: Rollback deployment
        run: |
          echo "ðŸ”„ Initiating rollback for production environment"
          echo "This would typically involve:"
          echo "1. Reverting Lambda function to previous version"
          echo "2. Restoring previous frontend version from backup"
          echo "3. Rolling back database migrations if any"
          echo "4. Notifying team of rollback"
          
          # å®Ÿéš›ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’ã“ã“ã«å®Ÿè£…
          # ä¾‹: AWS CLI ã‚’ä½¿ç”¨ã—ã¦å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™

      # TODO: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯é€šçŸ¥
      - name: Notify rollback
        run: |
          echo "## ðŸ”„ Rollback Executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Production deployment failed and has been rolled back to the previous stable version." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Rollback triggered by:** Deployment failure" >> $GITHUB_STEP_SUMMARY